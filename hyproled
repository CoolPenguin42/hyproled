#!/bin/bash
swap=false; invert=false; monitor=0
fill_color='0.0,0.0,0.0,1.0'

show_help(){
  cat <<EOF
Usage: $(basename $0) [OPTION]... [off]

Hyprland shader utility to prevent OLED burn in.

version: 0.1.1

Options:
  -a x:y:w:h  The effective area. Useful for bars. [Default: The entire screen]
  -i          Inverts the area. Useful for focus effect of a window or popup.
  -s          Swap lit pixels. Useful to prevent burn in, when called periodically.
  -m ID       Id of your oled monitor (hyprctl monitors). [Default: 0]
  -h          Display this help message.

Argument:
  off         Disable hyproled
EOF
}

if [[ $1 == off ]]; then
  hyprctl keyword decoration:screen_shader ""
  exit 0
fi

while getopts ":a:ism:h" opt; do
  case $opt in
    a) area=$OPTARG ;;
    s) swap=true ;;
    i) invert=true ;;
    m) monitor=$OPTARG ;;
    h) show_help; exit ;;
    *) show_help; exit 1 ;;
  esac
done
shift $((OPTIND-1))

# Base shader header
cat > /dev/shm/hyproled_shader.glsl <<EOF
#version 300 es
precision highp float;
in vec2 v_texcoord;
uniform sampler2D tex;
uniform int wl_output;
layout(location = 0) out vec4 fragColor;
void main(){
  vec4 orig = texture(tex, v_texcoord);
  if(wl_output != ${monitor}) { fragColor = orig; return; }
  vec2 fc = gl_FragCoord.xy;
  bool even = mod(fc.x + fc.y,2.0)==0.0;
EOF

# Setup pixel color
if $swap; then
  echo "  vec4 pixel = even ? vec4(${fill_color}) : orig;" >> /dev/shm/hyproled_shader.glsl
else
  echo "  vec4 pixel = even ? orig : vec4(${fill_color});" >> /dev/shm/hyproled_shader.glsl
fi

# Region logic
if [[ -n $area ]]; then
  if [[ $area =~ ^([0-9]+):([0-9]+):([0-9]+):([0-9]+)$ ]]; then
    read x y w h <<< "${BASH_REMATCH[*]:1:4}"
    echo "  bool inRegion = (fc.x >= ${x}.0 && fc.x <= (${x}.0+${w}.0) && fc.y >= ${y}.0 && fc.y <= (${y}.0+${h}.0));" >> /dev/shm/hyproled_shader.glsl
    if $invert; then
      echo "  fragColor = inRegion ? orig : pixel;" >> /dev/shm/hyproled_shader.glsl
    else
      echo "  fragColor = inRegion ? pixel : orig;" >> /dev/shm/hyproled_shader.glsl
    fi
  else
    echo "Invalid area format, use x:y:w:h" >&2; exit 1
  fi
else
  echo "  fragColor = pixel;" >> /dev/shm/hyproled_shader.glsl
fi

echo "}" >> /dev/shm/hyproled_shader.glsl

hyprctl keyword decoration:screen_shader /dev/shm/hyproled_shader.glsl
